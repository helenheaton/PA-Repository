SKIPCHECK;
FEEDSTRINGS;

['RPI / CPI to Use']=N:
IF(DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'Override RPI/CPI')<>0,
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'Override RPI/CPI'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI/CPI'));

['AWE / NLW to Use']=N:
IF(DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'Override AWE/NLW')<>0,
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'Override AWE/NLW'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE / NLW')
);

['AWE / NLW to Use Inc Pre 2010']=N:
IF(DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'Override AWE/NLW')<>0,
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'Override AWE/NLW'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE / NLW')*
IF( DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE / NLW Pre 2010 Rate')=0,1, 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE / NLW Pre 2010 Rate')));


['AWE / NLW to Use Averaging']=N:
ROUNDP(
(0.5*
(DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
\
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE FY'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )))
+
(0.5*
((DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-2'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )^2)
\
(DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE FY'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
*
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', Attrs('t_Financial Year', !t_Financial Year, 'Year-2'), 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' ))
))
,4);

['RPI / CPI to Use 1% Collar']=N:
ROUNDP(
IF( DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI dataset'), 
'% Change' )<0.01,

  DB('Admin - Index Values', 
  DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI Month applied'), 
  Attrs('t_Financial Year', !t_Financial Year, 'Year-2'),
  DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI dataset'), 
  'Index Amount' )*1.01
  \
  DB('Admin - Index Values', 
  DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI Month applied'), 
  DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI FY'), 
  DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI dataset'), 
  'Index Amount' )
  , ['RPI / CPI'])
,4);


['% AEI / NLW']=N:
1-['% RPI / CPI'];

['Mixed']= N:
(['% RPI / CPI']*['RPI / CPI'])+(['% AEI / NLW']*['AWE / NLW']);

#de Montfort override Mixed needs to include the pre 2010 AWE 
['Override AWE/NLW']=N:
IF((!Contract)@='De Montfort' & (!t_Financial Year)@>'2010',
['AWE / NLW']*['AWE / NLW Pre 2010 Rate']
,STET);

['Override Mixed']= N:
(['% RPI / CPI']*['RPI / CPI to Use'])+(['% AEI / NLW']*['AWE / NLW to Use']);

['RPI / CPI']=N: 
# the index published in relation to February each year to work out the increase in income for the coming financial year
ROUNDP(
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI dataset'), 
'Index Amount' )
\
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI Month applied'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI FY'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI dataset'), 
'Index Amount' )
,4);

['AWE / NLW']=N: 
ROUNDP(
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
\
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE FY'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
,4);

['AWE / NLW to Use Year on Year']=N: 
ROUNDP(
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
\
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-2'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
,4);


['RPI / CPI to Use Year on Year']=N: 
# the index published in relation to February each year to work out the increase in income for the coming financial year
ROUNDP(
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI dataset'), 
'Index Amount' )
\
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-2'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'RPI dataset'), 
'Index Amount' )
,4);

['Mixed Year on Year']= N:
(['% RPI / CPI']*['RPI / CPI to Use Year on Year'])+(['% AEI / NLW']*['AWE / NLW to Use Year on Year']);

['Northants UC to Use']=N:
(['% RPI / CPI']*['RPI / CPI to Use 1% Collar'])+
ROUNDP(
((0.5*['% AEI / NLW'])*
(DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
\
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE FY'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )))
+
((0.5*['% AEI / NLW'])*
((DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', !t_Financial Year, 'Year-2'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )^2)
\
(DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE FY'), 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' )
*
DB('Admin - Index Values', 
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
Attrs('t_Financial Year', Attrs('t_Financial Year', !t_Financial Year, 'Year-2'), 'Year-1'),
DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
'Index Amount' ))
))
,4);



#(['% RPI / CPI']*['RPI / CPI to Use 1% Collar'])+
#(0.5*['% AEI / NLW'])*['AWE / NLW']+

#(0.5*['% AEI / NLW'])*
#(DB('Admin - Index Values', 
#DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
#Attrs('t_Financial Year', !t_Financial Year, 'Year-1'),
#DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
#'Index Amount' ))
#/
#DB('Admin - Index Values', 
#DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE Month applied'), 
#DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE FY'), 
#DB('Admin - Index Rates',  !t_Financial Year, !Contract, 'AWE dataset'), 
#'Index Amount');

FEEDERS;

['% RPI / CPI']=>['% AEI / NLW'];
['% RPI / CPI']=>['Mixed'];
['% RPI / CPI']=>['Override Mixed'];
['% RPI / CPI']=>['Mixed Year on Year'];


# Feeding from same cube rather than cross cubes. 
# Month has to be entered for these to be populated. 
['AWE Month applied']  => ['AWE / NLW'];
['AWE Month applied']  => ['AWE / NLW to Use'];
#['Override AWE/NLW']   => ['AWE / NLW to Use'];#Check if I need this as I'm now adding in a rule for it above
['AWE Month applied']  => ['AWE / NLW to Use Inc Pre 2010'];
['AWE Month applied']  => ['AWE / NLW to Use Averaging'];
['AWE Month applied']  => ['AWE / NLW to Use Year on Year'];

['RPI Month applied']  => ['RPI / CPI'];
['RPI Month applied']  => ['RPI / CPI to Use'];
['Override RPI/CPI']   => ['RPI / CPI to Use'];
['RPI Month applied']  => ['RPI / CPI to Use 1% Collar'];
['RPI Month applied']  => ['RPI / CPI to Use Year on Year'];
